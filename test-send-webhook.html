<!DOCTYPE html>
<html>
<head>
    <title>Send Token Report to Make.com Webhook</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; white-space: pre-wrap; }
        .error { background: #ffebee; }
        .success { background: #e8f5e8; }
        button { padding: 10px 20px; margin: 5px; }
        .data { max-height: 300px; overflow-y: auto; background: #f0f0f0; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Send Latest Token Report to Make.com</h1>
    <button onclick="sendLatestReport()">Send Latest Token Report to Make.com</button>
    
    <div id="output"></div>
    
    <script>
    function log(message, isError = false) {
        const div = document.createElement('div');
        div.className = 'log ' + (isError ? 'error' : 'success');
        div.textContent = `[${new Date().toISOString()}] ${message}`;
        document.getElementById('output').appendChild(div);
    }
    
    async function sendLatestReport() {
        log('Sending latest token report to Make.com webhook...');
        
        // The most recent token report data from the database
        const latestRecord = {
            "id": "23d54bab-f930-4d5a-8132-3091ce190ee9",
            "token_name": "Aerodrome",
            "token_symbol": "AERO",
            "token_address": "0x940181a94a35a4569e4529a3cdfb74e38fd98631",
            "chain_id": "0x2105",
            "report_content": {
                "metadata": {
                    "chainId": "0x2105",
                    "currentPrice": 1.3626847604723464,
                    "generatedAt": "2025-08-26T20:15:35.821Z",
                    "generatedBy": "ai",
                    "marketCap": 1207106846.38,
                    "overallScore": 68,
                    "scores": {
                        "community": 70,
                        "development": 65,
                        "liquidity": 55,
                        "security": 69,
                        "tokenomics": 81
                    },
                    "tokenAddress": "0x940181a94a35a4569e4529a3cdfb74e38fd98631",
                    "tokenName": "Aerodrome",
                    "tokenSymbol": "AERO"
                },
                "communityAnalysis": {
                    "summary": "Community analysis shows a moderately engaged user base across social media platforms, indicating potential for growth.",
                    "keyPoints": [
                        "Twitter Followers: AERO has over 111,000 followers on Twitter, suggesting strong community interest.",
                        "Discord Members: With 12,353 members on Discord, the community engagement is relatively healthy.",
                        "Growth Potential: The active social media presence may aid in attracting new users and investors."
                    ]
                },
                "securityAnalysis": {
                    "summary": "The security analysis shows that the AERO token has a verified smart contract, indicating a level of trust in its code integrity.",
                    "keyPoints": [
                        "Contract Verified: The AERO smart contract is verified, which is crucial for trustworthiness.",
                        "No Freeze Authority: The absence of freeze authority implies that no individual can halt token transactions, which is generally favorable.",
                        "Can Mint: The ability to mint new tokens could lead to inflationary pressures if not managed properly."
                    ]
                }
            },
            "generated_by": "a97608f8-5df3-4780-9832-d15cbe8414ac",
            "created_at": "2025-08-26T20:15:36.229447+00:00",
            "updated_at": null
        };
        
        log('Token data preview:');
        const dataDiv = document.createElement('div');
        dataDiv.className = 'data';
        dataDiv.textContent = JSON.stringify(latestRecord, null, 2);
        document.getElementById('output').appendChild(dataDiv);
        
        try {
            // Send directly to Make.com webhook
            const response = await fetch('https://hook.us2.make.com/6agypb495rymylvki6b0iw9iofu6pkds', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ...latestRecord,
                    webhook_triggered_at: new Date().toISOString(),
                    source: 'token_health_scan_manual_test'
                })
            });
            
            log(`Make.com response status: ${response.status}`);
            
            const result = await response.text();
            log(`Make.com response: ${result}`);
            
            if (response.ok) {
                log(`✅ Successfully sent token report to Make.com!`);
            } else {
                log(`❌ Make.com webhook failed: ${response.status} ${response.statusText}`, true);
            }
            
        } catch (error) {
            log(`❌ Error sending to Make.com: ${error.message}`, true);
        }
        
        log('---');
        
        // Also test via our Supabase edge function
        try {
            log('Testing via Supabase edge function...');
            const edgeResponse = await fetch('https://qaqebpcqespvzbfwawlp.supabase.co/functions/v1/make-webhook', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ record: latestRecord })
            });
            
            log(`Edge function response status: ${edgeResponse.status}`);
            
            const edgeData = await edgeResponse.json();
            log(`Edge function response: ${JSON.stringify(edgeData, null, 2)}`);
            
            if (edgeData.success) {
                log(`✅ Edge function test successful!`);
            } else {
                log(`❌ Edge function test failed: ${edgeData.error}`, true);
            }
        } catch (error) {
            log(`❌ Error testing edge function: ${error.message}`, true);
        }
    }
    </script>
</body>
</html>